---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.16.2
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
import base64
import requests
import json
import os
import pdb
from PIL import Image
import numpy as np 
from typing import Union
import io

def image2base64(image: Union[np.ndarray, Image.Image], image_format: str = "JPEG", quality: int = 100) -> str:
    if isinstance(image, np.ndarray):
        im = Image.fromarray(image)
    elif isinstance(image, Image.Image):
        im = image
    else:
        raise ValueError(f"image should be np.ndarray or PIL.Image, not {type(image)}")

    buffered = io.BytesIO()
    im.save(buffered, format=image_format, quality=quality)
    return base64.b64encode(buffered.getvalue()).decode("utf-8")

def key_extraction(file_path):
    if os.path.exists(file_path) is False:
        raise FileNotFoundError(f"GPT api key file not found: {file_path}")
    with open(file_path, "r") as f:
        data = json.load(f)
        key = data["gpt"]
    return key
    

# Function to encode the image
def encode_image(image_path):
    with open(image_path, "rb") as image_file:
        image = Image.open(image_path).convert("RGB")
        img = np.asarray(image)
        img = image2base64(img)
        return img
        # import pdb; pdb.set_trace()
        img = base64.b64encode(img)
        img = img.decode("utf-8")
        return img

def img2text(
    image_path,
    api_key,
    model="gpt-4o",
    query="How many pushpins are there?",
):
    """
    image text extracton using LLM model, so far only support gpt-4o model
    # TODO
    # add other LLM model, particular for some small model for the ablation study
    """

    api_key = key_extraction(api_key)
    # Getting the base64 string
    base64_image = encode_image(image_path)

    headers = {"Content-Type": "application/json", "Authorization": f"Bearer {api_key}"}

    payload = {
        "model": model,
        "messages": [
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": f"{query}"},
                    {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}},
                ],
            }
        ],
        "max_tokens": 300,
    }
    try:
        response = requests.post("https://api.openai.com/v1/chat/completions", headers=headers, json=payload)
        output = response.json()
    except Exception as e:
        print(f"Have problem in extracting text, Error in the request: {e}")
        output = None
    return output
```

```{python}
path = "/home/erjin/git/Logic_AD_LLM/tests/test_data/few_pushping.png"
```

```{python}
api_key = "/home/erjin/git/Logic_AD_LLM/keys/gpt.json"
```

```{python}
img2text(path, api_key)
```

```{python}

```
